<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>彼岸花とゴミ虫</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: linear-gradient(270deg, #ffd6e0, #ffe0f7, #d6f0ff, #e0ffe8, #fff0d6);
    background-size: 1200% 1200%;
    animation: gradientShift 30s ease infinite;
  }
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  canvas {
    display: block;
  }
  .face {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 80px;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.9);
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .celebration {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    font-size: 40px;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 0 0 15px rgba(255, 255, 255, 0.9);
    pointer-events: none;
    z-index: 1000;
    animation: fadeInOut 3s ease;
  }
  @keyframes fadeInOut {
    0%, 100% { opacity: 0; }
    10%, 90% { opacity: 1; }
  }
  @keyframes rainbowBlink {
    0% { color: #ffb3ba; text-shadow: 0 0 15px #ffb3ba; }
    14% { color: #ffd4a3; text-shadow: 0 0 15px #ffd4a3; }
    28% { color: #ffffba; text-shadow: 0 0 15px #ffffba; }
    42% { color: #baffc9; text-shadow: 0 0 15px #baffc9; }
    57% { color: #bae1ff; text-shadow: 0 0 15px #bae1ff; }
    71% { color: #d4baff; text-shadow: 0 0 15px #d4baff; }
    85% { color: #ffbaee; text-shadow: 0 0 15px #ffbaee; }
    100% { color: #ffb3ba; text-shadow: 0 0 15px #ffb3ba; }
  }
</style>
</head>
<body>
<canvas id="sky"></canvas>
<div class="face" id="face1">（^ ω^）</div>
<div class="face" id="face2">(　ﾟ　Д　ﾟ 　)</div>
<div class="celebration" id="celebration"></div>

<script>
const canvas = document.getElementById("sky");
const ctx = canvas.getContext("2d");
let w, h;

function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// ゴミ虫のクリックカウント
let bugClickCount = 0;
let celebrating = false;

// ゴミ虫（スマホ対応で数を調整）
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const bugCount = isMobile ? 500 : 1000;
const rainbowColors = [
  "#c7d0ff", "#f7c7ff", "#ffd6e0", "#fff0d6", "#e0ffe8", "#d6f0ff"
];
const bugs = Array.from({ length: bugCount }, () => ({
  x: Math.random() * w,
  y: Math.random() * h,
  r: Math.random() * 2 + 1.5,
  speed: Math.random() * 0.6 + 0.2,
  color: rainbowColors[Math.floor(Math.random() * rainbowColors.length)],
  phase: Math.random() * Math.PI * 2
}));

// 彼岸花のクリックカウントと色設定
let lilyClickCount = 0;
let rainbowOffset = 0; // 虹色回転用
let lilySize = 1.0; // 彼岸花のサイズ倍率
let lilyRainbowMode = false; // ゴミ虫50回でのレインボーモード
const lilyColors = [
  { color: "rgba(255,0,0,0.75)", shadow: "rgba(255,60,60,0.9)" },      // 赤（初期）
  { color: "rgba(100,200,255,0.75)", shadow: "rgba(100,200,255,0.9)" }, // 水色
  { color: "rgba(255,220,100,0.75)", shadow: "rgba(255,220,100,0.9)" }, // 黄色
  { color: "rgba(200,150,255,0.75)", shadow: "rgba(200,150,255,0.9)" }, // 薄紫
  { color: "rgba(255,150,80,0.75)", shadow: "rgba(255,150,80,0.9)" },   // オレンジ
  { color: "rgba(100,255,150,0.75)", shadow: "rgba(100,255,150,0.9)" }  // 緑
];

// ペールトーン虹色パレット
const paleRainbow = [
  "rgba(255,179,186,0.75)", // ペールピンク
  "rgba(255,212,163,0.75)", // ペールオレンジ
  "rgba(255,255,186,0.75)", // ペールイエロー
  "rgba(186,255,201,0.75)", // ペールミント
  "rgba(186,225,255,0.75)", // ペールブルー
  "rgba(212,186,255,0.75)", // ペールラベンダー
  "rgba(255,186,238,0.75)"  // ペールマゼンタ
];

function getCurrentLilyColor(petalIndex) {
  // ゴミ虫50回達成のレインボーモードが優先
  if (lilyRainbowMode) {
    return paleRainbow[(petalIndex + rainbowOffset) % paleRainbow.length];
  }
  
  if (lilyClickCount > 100) {
    // 通常の虹色モード（回転）
    const rainbowPalette = [
      "rgba(255,0,0,0.75)", "rgba(255,127,0,0.75)", "rgba(255,255,0,0.75)",
      "rgba(0,255,0,0.75)", "rgba(0,127,255,0.75)", "rgba(0,0,255,0.75)", "rgba(139,0,255,0.75)"
    ];
    return rainbowPalette[(petalIndex + rainbowOffset) % rainbowPalette.length];
  } else {
    const colorIndex = Math.floor(lilyClickCount / 15) % lilyColors.length;
    return lilyColors[colorIndex].color;
  }
}

function getCurrentLilyShadow() {
  if (lilyRainbowMode || lilyClickCount > 100) {
    return "rgba(255,255,255,0.9)";
  } else {
    const colorIndex = Math.floor(lilyClickCount / 15) % lilyColors.length;
    return lilyColors[colorIndex].shadow;
  }
}

// 彼岸花
function drawSpiderLily() {
  const cx = w / 2, cy = h - 80;
  ctx.save();
  ctx.translate(cx, cy);
  
  // サイズ変更適用
  ctx.scale(lilySize, lilySize);
  
  ctx.strokeStyle = "#3a1818";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(0, -120);
  ctx.stroke();

  for (let i = 0; i < 40; i++) {
    const angle = (i / 40) * Math.PI * 2;
    const x = Math.cos(angle) * 50;
    const y = -120 + Math.sin(angle) * 50;
    ctx.beginPath();
    ctx.moveTo(0, -120);
    ctx.lineTo(x, y);
    ctx.strokeStyle = getCurrentLilyColor(i);
    ctx.lineWidth = 2;
    ctx.shadowBlur = 12;
    ctx.shadowColor = getCurrentLilyShadow();
    ctx.stroke();
  }
  ctx.restore();
  ctx.shadowBlur = 0;
}

// 顔文字の出現
function showFace(faceId) {
  const el = document.getElementById(faceId);
  el.style.opacity = 1;
  setTimeout(() => (el.style.opacity = 0), 800);
}

// 500回達成時の演出
function celebrate(level = 1) {
  if (celebrating) return;
  celebrating = true;
  
  const celebDiv = document.getElementById('celebration');
  celebDiv.innerHTML = '';
  const faces = ['（^ ω^）', '(　ﾟ　Д　ﾟ 　)'];
  
  // 画面いっぱいに顔文字を敷き詰める
  const rows = Math.ceil(window.innerHeight / 50);
  const cols = Math.ceil(window.innerWidth / 80);
  
  const rainbowColors = [
    '#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0080ff', '#0000ff', '#8b00ff'
  ];
  
  for (let i = 0; i < rows * cols; i++) {
    const span = document.createElement('span');
    span.textContent = faces[Math.floor(Math.random() * faces.length)];
    span.style.margin = '5px';
    
    // 100回以上なら虹色アニメーション
    if (level >= 2) {
      span.style.animation = 'rainbowBlink 0.5s infinite';
      span.style.animationDelay = `${Math.random() * 0.5}s`;
    }
    
    celebDiv.appendChild(span);
  }
  
  celebDiv.style.display = 'flex';
  
  // 3秒後に消える
  setTimeout(() => {
    celebDiv.style.display = 'none';
    celebrating = false;
  }, 3000);
}

// 音追加部分
let audioCtx = null;
function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playBeep(frequency = 800, duration = 0.1) {
  initAudio();
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  oscillator.frequency.value = frequency;
  oscillator.type = 'sine';
  gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
  oscillator.start(audioCtx.currentTime);
  oscillator.stop(audioCtx.currentTime + duration);
}

// クリック・タッチ判定（当たり判定拡大 + 彼岸花クリック判定）
function handleInteraction(e) {
  e.preventDefault();
  const mx = (e.touches ? e.touches[0].clientX : e.clientX);
  const my = (e.touches ? e.touches[0].clientY : e.clientY);
  
  // 彼岸花のクリック判定
  const lilyCx = w / 2;
  const lilyCy = h - 80;
  const lilyDx = mx - lilyCx;
  const lilyDy = my - (lilyCy - 60); // 花の中心あたり
  if (lilyDx * lilyDx + lilyDy * lilyDy < 3600) { // 60px範囲
    lilyClickCount++;
    playBeep(1000, 0.15);
    return;
  }
  
  // ゴミ虫のクリック判定
  let hit = false;
  bugs.forEach(s => {
    const dx = s.x - mx, dy = s.y - my;
    if (dx * dx + dy * dy < 22500) { // 150pxに拡大
      if (!hit) {
        bugClickCount++;
        playBeep();
        showFace(Math.random() < 0.5 ? "face1" : "face2");
        hit = true;
        
        // 達成チェック
        if (bugClickCount === 10) {
          celebrate(1); // 通常版
        } else if (bugClickCount === 50) {
          // 彼岸花がペールトーン虹色&拡大
          lilyRainbowMode = true;
          lilySize = 1.3;
        } else if (bugClickCount === 100) {
          celebrate(2); // 虹色版
        }
      }
    }
  });
}
canvas.addEventListener("click", handleInteraction);
canvas.addEventListener("touchstart", handleInteraction);

function animate() {
  ctx.clearRect(0, 0, w, h);
  drawSpiderLily();
  bugs.forEach(s => {
    s.y += s.speed;
    s.x += Math.sin(s.y / 20 + s.phase) * 0.4;
    if (s.y > h) s.y = -10;
    ctx.fillStyle = s.color;
    ctx.shadowBlur = 6;
    ctx.shadowColor = s.color;
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    ctx.fill();
  });
  ctx.shadowBlur = 0;
  
  // 虹色モードの回転
  if (lilyClickCount > 100 || lilyRainbowMode) {
    rainbowOffset = (rainbowOffset + 1) % 7;
  }
  
  requestAnimationFrame(animate);
}

// ページロード時にAudioContext準備
window.addEventListener('load', initAudio);

animate();
</script>
</body>
</html>